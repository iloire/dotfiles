#!/bin/sh
#
# Pre-commit hook: validates user.email and scans for secrets

# Check user.email is configured
EMAIL=$(git config user.email)
if [ -z "$EMAIL" ]; then
    echo "ERROR: [pre-commit hook] Aborting commit because user.email is missing. Configure user.email for this repository by running: '$ git config user.email name@example.com'. Make sure not to configure globally and use the correct email."
    exit 1
fi

# Scan staged changes for secrets using gitleaks
if command -v gitleaks >/dev/null 2>&1; then
    gitleaks git --pre-commit --staged --no-banner
    if [ $? -ne 0 ]; then
        echo "ERROR: [pre-commit hook] gitleaks detected secrets in staged changes. Remove them before committing."
        echo "To bypass this check (use with caution): git commit --no-verify"
        exit 1
    fi
else
    echo "WARNING: [pre-commit hook] gitleaks is not installed. Skipping secret detection. Install it: https://github.com/gitleaks/gitleaks#installing"
fi
