#!/usr/bin/env bash
# Extract a time segment from a video, optionally rotating 90° counter-clockwise.
#
# Usage: video-clip <input> <start> <end> [--rotate] [-o output]
#
# Examples:
#   video-clip input.mp4 00:01:30 00:02:00
#   video-clip input.mp4 90 120 --rotate
#   video-clip input.mp4 0 60 --rotate -o trimmed.mp4

set -euo pipefail

usage() {
  echo "Usage: video-clip <input> <start> <end> [--rotate] [-o output]"
  echo ""
  echo "  <start>/<end>  Time in seconds or HH:MM:SS format"
  echo "  --rotate       Rotate 90° counter-clockwise"
  echo "  -o <file>      Output filename (default: <input>_clip.<ext>)"
  exit 1
}

[[ $# -lt 3 ]] && usage

input="$1"
start="$2"
end="$3"
shift 3

rotate=false
output=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --rotate) rotate=true; shift ;;
    -o) output="$2"; shift 2 ;;
    *) echo "Unknown option: $1"; usage ;;
  esac
done

[[ ! -f "$input" ]] && echo "File not found: $input" && exit 1

if [[ -z "$output" ]]; then
  ext="${input##*.}"
  base="${input%.*}"
  output="${base}_clip.${ext}"
fi

vf_args=()
$rotate && vf_args+=("transpose=2")

ffmpeg_args=(-i "$input" -ss "$start" -to "$end")

if [[ ${#vf_args[@]} -gt 0 ]]; then
  ffmpeg_args+=(-vf "$(IFS=,; echo "${vf_args[*]}")")
fi

ffmpeg_args+=(-c:a copy "$output")

ffmpeg "${ffmpeg_args[@]}"
echo "Saved to $output"
